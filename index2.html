<!doctype html>
<html>

  <head>
    <title>UNSW CCS</title>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jspsych.js"></script>
    <script src="./js/plugins/jspsych-survey-multi-choice.js"></script>
	  <script src="./js/plugins/jspsych-html-button-response.js"></script>
    <script src="./js/plugins/jspsych-html-keyboard-response.js"></script>
	  <script src="./js/welcome.js"></script>
    <link href="./js/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>

  <body>
	  <div id="welcome"></div>
  </body>

  <script>

    /* initialise timeline*/
    var timeline=[];
    var introloop=[];
    var turkcode = (Math.floor(Math.random() * 899999) + 100000).toString();
	  var images = [
		  './img/test1.jpg',
		  './img/test2.jpg',
      './img/RiskResponseTable.jpg',
      './img/Category_button_NotCP.jpg',
      './img/Category_button_Prob.jpg',
      './img/Category_button_HRN.jpg',
      './img/Category_button_ROSH.jpg',
      './img/Category_button_iROSH.jpg',
      './img/greenTick.png',
      './img/redCross.png',
      './img/HRN_23b.jpg',
      './img/HRN_25.jpg',
      './img/HRN_32.jpg',
      './img/HRN_54a.jpg',
      './img/HRN_59a.jpg',
      './img/HRN_61b.jpg',
      './img/HRN_66a.jpg',
      './img/HRN_96a.jpg',
      './img/HRN_100.jpg',
      './img/iROSH_17b.jpg',
      './img/iROSH_24b.jpg',
      './img/iROSH_37e.jpg',
	  ];

    /* function to start the jsPsych experiment */
    function startExperiment(){

      // record the turkcode in the jsPsych data
      jsPsych.data.addProperties({
        turkcode: turkcode
      });

      jsPsych.init({
        timeline: timeline,
        preload_images: images,
        on_finish: function() {
          endExperiment( jsPsych.data.get().csv(), function() { document.write('<div id="endscreen" class="endscreen" style="width:1000px"><div class="endscreen" style="text-align:center; border:0px solid; padding:10px; font-size:120%; width:800px; float:right"><p><br><br><br>All done!<br><br>Your completion code is <span id="turkcode" style="font-weight:bold;font-size:130%">' + turkcode + '</span>. To receive payment for the HIT, return to the Amazon Mechanical Turk page and enter this code. Please contact us if something goes wrong and we\'ll fix it as quickly as possible.</p></div></div>') })
        }
      });
    }

    /* save and finish */
    function endExperiment(dataset,callback) {
      // $.post('submit',{"content": dataset}); // uncomment to post data
      console.log(dataset) // comment out to avoid console log
      setTimeout(callback,1000)
    }

    /* change the display property of a set of objects */
    function setDisplay(theClass, theValue) {
      var i, classElements = document.getElementsByClassName(theClass);
      for (i = 0; i < classElements.length; i = i + 1) {
        classElements[i].style.display = theValue;
      }
    }

    /* A grossly typical way to run the instructions is to go through a series
    of small slides (implemeted as trials in jsPsych) with a minimum reading time
    enforced for each slide, such that the "continue" button doesn't appear until
    the time elapses. At the end of the instructions, there is a short quiz, and if
    the participant gets them wrong they are sent back to the beginning */

    /* define the instruction block */
    var instruction_block = {
      type: 'html-button-response',
      timing_post_trial: 0,
      choices: ['Click here to continue'],
      on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 1000)},
      is_html: true,
      timeline: [
        {stimulus: '<br><br><b>Child Protection Response Options in New South Wales </b><br><br>Each column in the table below represents a category of response options based upon the level of risk of a given situation.<br><br> Please read this table carefully. <br><br><br><br><img src="img/RiskResponseTable.jpg" width="1400px"></img><br><br>'},
            // insert image img src =
            ]
    };
  //  introloop.push(instruction_block); // <- the setup block gets pushed to a "loop node"

    /* define instruction check block */
    var instructioncorrect = false;
    var instruction_check = {
        type: "survey-multi-choice",
        preamble: ["<p align='center'><b>Check your knowledge before you begin!</b></p>"],
        questions: [
          {prompt: "<b>Question 1</b>: True or false?: All situations where you suspect a child/young person is at risk of harm needs to be reported to the FaCS Child Protection Helpline.", options: [" True"," False"], required: true},
          {prompt: "<b>Question 2</b>: Which statement is false?", options: [" ALL HRN situations need to be reported to the FaCS Child Protection Helpline", " You may need to consider calling Emergency Services for iROSH situations", " Supporting the family to engage with family support services is an appropriate response for HRN situations"], required: true},
          {prompt: "<b>Question 3</b>: Australian child protection legislation covers all young people under the age of...", options: [" 16 years"," 18 years", " 21 years"], required: true}
        ],
        on_finish: function(data) {
          if( data.responses == '{"Q0":" False","Q1":" ALL HRN situations need to be reported to the FaCS Child Protection Helpline","Q2":" 18 years"}') {
            action = false;
            instructioncorrect = true;
          }
        }
    }
  //  introloop.push(instruction_check)

    /* define a page for the incorrect response */
    var showsplash = true;
    var splash_screen = {
      type: 'html-button-response',
      timing_post_trial: 0,
	//    button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
      choices: ['Click here to read the instructions again'],
      on_trial_start: function() {setTimeout(function() {setDisplay("jspsych-btn","")}, 500)},
      is_html: true,
      stimulus: 'Unfortunately, at least one of your answers was incorrect.'
    }

    /* ...but push it to a conditional node that only shows it if the response was wrong */
    var conditional_splash = {
      timeline: [splash_screen],
      conditional_function: function(data) {
        return !instructioncorrect // skip if correct
      }
    }
  //  introloop.push(conditional_splash)

    /* finally, add the entirety of this introductory section to a loop node ... */
    var loop_node = {
      timeline: introloop,
      loop_function: function(data) {
        //var action = true;
        return !instructioncorrect // stop looping if correct
      }
    }
  //  timeline.push(loop_node) // ... and add that to the timeline

    /* success trial */
    var successtrial = {
      type: 'html-button-response',
      timing_post_trial: 0,
	//    button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
      choices: ['Click here to begin the experiment'],
      on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 500)},
      is_html: true,
      stimulus: 'Well done!'
    };
  //  timeline.push(successtrial);

    // create category buttons, define variables to use later
    categoryButtons = ["Category_button_NotCP","Category_button_Prob","Category_button_HRN","Category_button_ROSH","Category_button_iROSH"];
    var scenarios = ["HRN_32","HRN_25","HRN_54a","HRN_59a"];
    // 32 = psychologist, 25 = midwife
    var correctResponse = [2,0,1,3];

    //wtf ?
    var i = 0;

    // the trial
    var testTrial = {
      type: 'html-button-response',
      stimulus: "<img src ='img/" + scenarios[i] + ".jpg' width=1000px>",
      button_html: '<button><img src="img/%choice%.jpg" width="260px"></button>',
      choices: categoryButtons,
      post_trial_gap: 100,
      //on_start:function(data){i=i+1} nor i=i didn't work; we can't put in on_finish
    };

    // the feedback
    var testFeedback = {
      type: 'html-keyboard-response',
      is_html:true,
      stimulus: function(data){
          var lastClick = jsPsych.data.get().last(1).values()[0].button_pressed;
          var lastChoice = categoryButtons[jsPsych.data.get().last(1).values()[0].button_pressed];
          if (lastClick == correctResponse[i]) {
            return "<b>You chose</b> <br><br><img src='img/" + lastChoice + ".jpg' width = 280px><img src='img/greenTick.png' width = 280px>"
          } else {
            return "<b>You chose</b> <br><br><img src='img/" + lastChoice + ".jpg' width = 280px><img src='img/redCross.png' width = 280px>"
          }
          // also, return <imgsrc='img/"+ feedbackHRN[i] + ".jpg'>
          // you need to create feedbackHRN variable, where the array objects are ["HRN_32_feedback"."HRN_35_feedback"]
        },
      choices: jsPsych.NO_KEYS,
      trial_duration: 1400,
      on_finish: function(data){i = i + 1}, //need this to stay until the next testTrial, so that scenarios[i] now = scenarios[i+1]
    };

    var testBlock = {
      timeline: [testTrial, testFeedback],
      repetitions: 4,
      randomize_order: false,
    };

    timeline.push(testBlock);
    /* define the instruction block */
    // var experiment_block = {
    // type: 'html-button-response',
    //  timing_post_trial: 0,
//	    button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
  //    choices: ['Click here to continue'],
  //    on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 500)},
  //    is_html: true,
  //    timeline: [
  //      {stimulus: 'This is the first experimental trial'},
	//	    {stimulus: 'This is the second experimental trial'}
  //    ]
  //  };
  //  timeline.push(experiment_block);


    /* start by running the "welcome" */
    welcome.run();

  </script>
</html>
